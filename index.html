<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pickeo de Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#2a7de1; --ok:#16a34a; --bad:#dc2626; --light:#f6f7fb; --border:#e5e7eb; --text:#0f172a; --sub:#475569; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--light);color:var(--text)}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 14px}
    .topbar{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:#fff}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px}
    .status{display:flex;gap:10px;align-items:center;margin-top:8px;font-weight:600}
    .status .ok{color:var(--ok)}
    .status .bad{color:var(--bad)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2f7;font-size:12px;margin-left:8px}
    .flex{display:flex;gap:10px;align-items:center}
    button{padding:10px 14px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px;background:#f8fafc}
    th{font-size:13px;color:#475569;background:#eef2ff}
    td.count{text-align:center;width:120px}
    .section-title{display:flex;align-items:center;gap:8px;margin:20px 0 8px}
    @media (max-width: 900px){ .topbar{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pickeo de Stock</h1>

    <!-- Encabezado -->
    <section class="topbar">
      <div>
        <label for="responsable">Responsable</label>
        <input id="responsable" type="text" placeholder="Ej: Damian Garcia" />
      </div>
      <div>
        <label for="piso">Piso</label>
        <select id="piso">
          <option value="">Seleccionar...</option>
          <option value="LOCAL">LOCAL</option>
          <option value="DEPOSITO">DEPOSITO</option>
          <option value="WEB">WEB</option>
          <option value="PEDIDOS">PEDIDOS</option>
        </select>
      </div>
      <div>
        <label for="sector">Sector</label>
        <input id="sector" type="text" placeholder="Ej: Ingreso / Salida / Lencería" />
      </div>
    </section>

    <!-- Pickeo -->
    <section class="card">
      <div class="flex" style="justify-content:space-between;flex-wrap:wrap;gap:12px">
        <div class="flex" style="gap:12px;flex:1 1 320px">
          <div style="flex:1">
            <label for="scan">Escanear / pegar códigos</label>
            <input id="scan" type="text" placeholder="Enfocá aquí y escaneá (Enter para confirmar)" autocomplete="off" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="confirmar">Confirmar</button>
          </div>
        </div>
        <div class="status" id="estado"><span class="bad">Pendiente</span></div>
      </div>

      <div class="flex" style="margin-top:8px;flex-wrap:wrap">
        <div class="pill" id="pillTotal">0 válidos totales</div>
        <div class="pill" id="pillUnicos">0 válidos únicos</div>
        <div class="pill" id="pillInvalidos">0 inválidos</div>
      </div>

      <div class="flex" style="margin:12px 0;flex-wrap:wrap;gap:8px">
        <button id="descargarValidos">Descargar TXT válidos</button>
        <button id="descargarInvalidos">Descargar TXT inválidos</button>
      </div>

      <div style="overflow:auto;margin-top:6px">
        <table>
          <thead>
            <tr>
              <th style="width:72px">#</th>
              <th>Código</th>
              <th>Artículo</th>
              <th>Color</th>
              <th>Talle</th>
              <th class="count">Cantidad</th>
            </tr>
          </thead>
          <tbody id="tablaValidos"></tbody>
        </table>
      </div>

      <!-- INVÁLIDOS -->
      <div class="section-title">
        <h2 style="margin:0;font-size:18px">Códigos inválidos</h2>
        <span class="pill" id="pillInvalidos2">0 códigos</span>
      </div>

      <div style="overflow:auto;margin-top:6px">
        <table>
          <thead>
            <tr>
              <th style="width:72px">#</th>
              <th>Código</th>
              <th class="count">Cantidad</th>
            </tr>
          </thead>
          <tbody id="tablaInvalidos"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ========= Estado =========
    let picks = [];                // válidos (normalizados) con repetidos
    let counts = new Map();        // code -> cantidad
    let invalidPicks = [];         // inválidos (normalizados) con repetidos
    let invalidCounts = new Map(); // code -> cantidad

    // Índices de validación
    const codeInfo = new Map();    // CODE_NORMAL -> {codigo, articulo, color, talle}
    const comboToCode = new Map(); // ART|COLOR|TALLE (norm) -> CODE_NORMAL

    const $ = (s) => document.querySelector(s);

    // ========= Utiles =========
    const norm = (s) => (s || '').toString().trim().toLocaleUpperCase('es-AR');

    const sanitizeForFile = (s) => s.normalize('NFKD')
      .replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-zA-Z0-9]+/g,'_')
      .replace(/^_+|_+$/g,'')
      .toUpperCase();

    const yyyymmdd = () => {
      const d = new Date();
      return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('');
    };

    function setEstado(ok, msg){
      $('#estado').innerHTML = ok ? `<span class="ok">✅ ${msg||'Válido'}</span>`
                                  : `<span class="bad">❌ ${msg||'No registrado'}</span>`;
    }

    function updatePills(){
      $('#pillTotal').textContent    = `${picks.length} válidos totales`;
      $('#pillUnicos').textContent   = `${counts.size} válidos únicos`;
      $('#pillInvalidos').textContent  = `${invalidPicks.length} inválidos`;
      $('#pillInvalidos2').textContent = `${invalidCounts.size} códigos`;
    }

    function renderTablaValidos(){
      const tbody = $('#tablaValidos');
      tbody.innerHTML = '';
      let idx = 1;
      for (const [code, qty] of counts.entries()){
        const info = codeInfo.get(code) || {codigo: code, articulo:'-', color:'-', talle:'-'};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="background:#fff">${idx++}</td>
          <td>${info.codigo}</td>
          <td>${info.articulo}</td>
          <td>${info.color}</td>
          <td>${info.talle}</td>
          <td class="count">${qty}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderTablaInvalidos(){
      const tbody = $('#tablaInvalidos');
      tbody.innerHTML = '';
      let idx = 1;
      for (const [code, qty] of invalidCounts.entries()){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="background:#fff">${idx++}</td>
          <td>${code}</td>
          <td class="count">${qty}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Detecta formato "ART!COLOR!TALLE" y devuelve {articulo,color,talle} normalizados
    function parseComposite(raw){
      const txt = norm(raw);
      if (!txt.includes('!')) return null;
      const parts = txt.split('!').map(p=>p.trim()).filter(Boolean);
      if (parts.length !== 3) return null;
      return { articulo: parts[0], color: parts[1], talle: parts[2] };
    }

    function addValido(inputCode){
      const keyCode = norm(inputCode);
      if (!keyCode) return;

      // 1) Directo por código (columna "codigo")
      let info = codeInfo.get(keyCode);
      if (info){
        picks.push(keyCode);
        counts.set(keyCode, (counts.get(keyCode)||0) + 1);
        setEstado(true, `${info.codigo} OK — ${info.articulo} / ${info.color} / ${info.talle}`);
        updatePills(); renderTablaValidos(); return;
      }

      // 2) Formato compuesto "ART!COLOR!TALLE"  -> buscar combinación
      const comp = parseComposite(inputCode);
      if (comp){
        const comboKey = `${comp.articulo}|${comp.color}|${comp.talle}`;
        const mappedCode = comboToCode.get(comboKey);
        if (mappedCode){
          const info2 = codeInfo.get(mappedCode); // existe por construcción
          picks.push(mappedCode);
          counts.set(mappedCode, (counts.get(mappedCode)||0) + 1);
          setEstado(true, `${info2.codigo} OK — ${info2.articulo} / ${info2.color} / ${info2.talle}`);
          updatePills(); renderTablaValidos(); return;
        }
      }

      // 3) No encontrado => inválido
      addInvalido(inputCode);
    }

    function addInvalido(inputCode){
      const k = norm(inputCode);
      invalidPicks.push(k);
      invalidCounts.set(k, (invalidCounts.get(k)||0) + 1);
      setEstado(false, `${inputCode} no está registrado`);
      updatePills(); renderTablaInvalidos();
    }

    function processRawInput(raw){
      const tokens = raw.split(/[\n,;\t ]+/).map(t=>t.trim()).filter(Boolean);
      for(const t of tokens) addValido(t);
    }

    // ========= Cargar equivalencias.csv =========
    fetch('equivalencias.csv')
      .then(r => r.text())
      .then(text => {
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length <= 1) { setEstado(false, 'equivalencias.csv vacío'); return; }

        const header = lines[0].split(';').map(c => c.replace(/^"|"$|(\r)/g,'').trim().toLowerCase());
        const idx = (name, fb) => { const i = header.indexOf(name); return i >= 0 ? i : fb; };
        const iCodigo   = idx('codigo',   0);
        const iArticulo = idx('articulo', 1);
        const iColor    = idx('color',    2);
        const iTalle    = idx('talle',    3);

        for (const line of lines.slice(1)){
          const cols = line.split(';').map(c => c.replace(/^"|"$|(\r)/g,'').trim());
          const codigo   = cols[iCodigo]   ?? '';
          const articulo = cols[iArticulo] ?? '';
          const color    = cols[iColor]    ?? '';
          const talle    = cols[iTalle]    ?? '';
          const keyCode  = norm(codigo);
          if (!keyCode) continue;
          const info = { codigo, articulo, color, talle };
          codeInfo.set(keyCode, info);

          // índice por combinación (normalizada)
          const comboKey = `${norm(articulo)}|${norm(color)}|${norm(talle)}`;
          // si hay duplicados de combinación, mantenemos el primero
          if (!comboToCode.has(comboKey)) comboToCode.set(comboKey, keyCode);
        }
        setEstado(false, 'Base cargada. Escaneá para validar.');
      })
      .catch(() => setEstado(false, 'Error al cargar equivalencias.csv'));

    // ========= Interacción =========
    const scan = $('#scan');

    scan.addEventListener('keydown', (e)=> {
      if (e.key === 'Enter'){ e.preventDefault(); $('#confirmar').click(); }
    });

    scan.addEventListener('input', ()=>{
      const val = scan.value;
      if (!val.trim()){ setEstado(false,'Pendiente'); return; }

      // Previsualización: intenta resolver directo o por combinación
      const direct = codeInfo.get(norm(val));
      if (direct){
        setEstado(true, `Posible válido — ${direct.articulo} / ${direct.color} / ${direct.talle}`);
        return;
      }
      const comp = parseComposite(val);
      if (comp){
        const mapped = comboToCode.get(`${comp.articulo}|${comp.color}|${comp.talle}`);
        if (mapped){
          const info = codeInfo.get(mapped);
          setEstado(true, `Posible válido — ${info.articulo} / ${info.color} / ${info.talle}`);
          return;
        }
      }
      setEstado(false, 'No registrado');
    });

    $('#confirmar').addEventListener('click', ()=>{
      const raw = scan.value;
      if (!raw.trim()) return;
      processRawInput(raw);
      scan.value = ''; scan.focus();
    });

    // ======== Descargas ========
    function requireMeta(){
      const responsable = ($('#responsable').value||'').trim();
      const piso = ($('#piso').value||'').trim();
      const sector = ($('#sector').value||'').trim();
      if (!responsable) { alert('Completá el RESPONSABLE.'); return null; }
      if (!piso)        { alert('Seleccioná el PISO.');      return null; }
      if (!sector)      { alert('Completá el SECTOR.');      return null; }
      return {
        responsable: sanitizeForFile(responsable),
        piso: sanitizeForFile(piso),
        sector: sanitizeForFile(sector)
      };
    }

    function downloadTXT(lines, filename){
      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    }

    // Válidos (historial con repetidos; siempre se exporta el CÓDIGO real de la base)
    $('#descargarValidos').addEventListener('click', ()=>{
      if (picks.length === 0) return alert('No hay códigos válidos pickeados.');
      const meta = requireMeta(); if (!meta) return;
      const filename = `PICKEO_${yyyymmdd()}_${meta.piso}_${meta.sector}_${meta.responsable}.txt`;
      downloadTXT(picks, filename);
    });

    // Inválidos (historial con repetidos)
    $('#descargarInvalidos').addEventListener('click', ()=>{
      if (invalidPicks.length === 0) return alert('No hay códigos inválidos.');
      const meta = requireMeta(); if (!meta) return;
      const filename = `INVALIDOS_${yyyymmdd()}_${meta.piso}_${meta.sector}_${meta.responsable}.txt`;
      downloadTXT(invalidPicks, filename);
    });
  </script>
</body>
</html>
