<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pickeo de Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#2a7de1; --light:#f6f7fb; --border:#e5e7eb; --text:#0f172a; --sub:#475569; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--light);color:var(--text)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .topbar{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end}
    .muted{color:var(--sub)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px}
    .card h2{font-size:18px;margin:0 0 12px}
    label{display:block;font-weight:600;margin-top:10px}
    select,input[type="text"],textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:#fff}
    textarea{min-height:160px;resize:vertical;font-family:ui-monospace,Consolas,Menlo,monospace;line-height:1.3}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    button{width:100%;padding:12px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#0f172a}
    button.ghost{background:#eef2f7;color:#0f172a}
    button:hover{filter:brightness(.95)}
    ul{list-style:none;padding:0;margin:12px 0 0}
    li{background:#f1f5f9;padding:8px 12px;border-radius:8px;margin-bottom:6px;font-family:ui-monospace,Consolas,Menlo,monospace}
    .hint{margin-top:6px;color:#64748b;font-size:13px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2f7;font-size:12px;margin-left:8px}
    @media (max-width: 1000px){
      .topbar{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pickeo de Stock</h1>

    <!-- Barra superior: Responsable / Piso / Sector -->
    <div class="topbar">
      <div>
        <label for="responsable">Responsable</label>
        <input id="responsable" type="text" placeholder="Ej: Damian Garcia" />
      </div>
      <div>
        <label for="piso">Piso</label>
        <select id="piso">
          <option value="">Seleccionar...</option>
          <option value="LOCAL">LOCAL</option>
          <option value="DEPOSITO">DEPOSITO</option>
          <option value="WEB">WEB</option>
          <option value="PEDIDOS">PEDIDOS</option>
        </select>
      </div>
      <div>
        <label for="sector">Sector</label>
        <input id="sector" type="text" placeholder="Ej: Lencería / Ingreso / Salida" />
      </div>
    </div>

    <div class="grid">
      <!-- Columna Izquierda: Pickeo (ETIQUETAS) -->
      <section class="card">
        <h2>Pickeo <span class="pill" id="pillPickeo">0 totales • 0 únicos</span></h2>

        <label for="busquedaArticulo">Buscar artículo</label>
        <input id="busquedaArticulo" type="text" placeholder="Ej: 401 o 29-4" />

        <div class="row">
          <div>
            <label for="articulo">Artículo</label>
            <select id="articulo"><option value="">Cargando...</option></select>
          </div>
          <div>
            <label for="color">Color</label>
            <select id="color" disabled><option value="">Seleccionar artículo</option></select>
          </div>
        </div>

        <label for="talle">Talle</label>
        <select id="talle" disabled><option value="">Seleccionar color</option></select>

        <div class="row-3" style="margin-top:10px">
          <button id="agregar">Agregar a pickeo</button>
          <button id="descargar">Descargar TXT de PICKEO</button>
          <button id="limpiarPickeo" class="ghost">Limpiar</button>
        </div>

        <div class="hint">Tip: permitir repetidos = cantidad. El TXT sale con FECHA, PISO, SECTOR y RESPONSABLE.</div>
        <ul id="lista"></ul>
      </section>

      <!-- Columna Derecha: BAJAS -->
      <section class="card">
        <h2>Bajas <span class="pill" id="pillBajas">0 códigos</span></h2>

        <label for="bajasInput">Pegá o scanneá los códigos a dar de baja</label>
        <textarea id="bajasInput" placeholder="PICKEA ACÁ TODOS LOS ARTÍCULOS PARA DAR DE BAJA"></textarea>
        <div class="row-3" style="margin-top:10px">
          <button id="descargarBajas">Descargar TXT de BAJAS</button>
          <button id="limpiarBajas" class="secondary">Limpiar</button>
          <button id="copiarBajas" class="ghost">Copiar</button>
        </div>
        <div class="hint">Se deduplican automáticamente y se mantiene el orden de ingreso.</div>
      </section>
    </div>
  </div>

  <script>
    // ---------- Estado ----------
    let registros = [];
    let lista = []; // pickeo (permitimos repetidos para representar cantidad)

    const $ = (sel) => document.querySelector(sel);

    // ---------- Carga de equivalencias.csv ----------
    fetch('equivalencias.csv')
      .then(r => r.text())
      .then(text => {
        // Admite ; como separador. Ignora líneas vacías.
        const lines = text.split(/\r?\n/).filter(Boolean);
        registros = lines.slice(1).map(line => {
          // Soporte de CSV con comillas y ; — y caracteres latinos
          const cols = line.split(';').map(c => c.replace(/^"|"$|(\r)/g, '').trim());
          return { codigo: cols[0], articulo: cols[1], color: cols[2], talle: cols[3] };
        }).filter(r => r.codigo && r.articulo && r.color && r.talle);

        // Poblar artículos únicos
        poblarArticulos();
      })
      .catch(() => {
        $('#articulo').innerHTML = '<option value="">Error al cargar equivalencias.csv</option>';
      });

    function poblarArticulos() {
      const articulos = [...new Set(registros.map(r => r.articulo))].sort();
      const artSelect = $('#articulo');
      artSelect.innerHTML = '<option value="">Seleccionar...</option>';
      articulos.forEach(art => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = art;
        artSelect.appendChild(opt);
      });
    }

    // ---------- Buscador de artículo ----------
    $('#busquedaArticulo').addEventListener('input', function () {
      const filtro = this.value.trim().toLowerCase();
      const artSelect = $('#articulo');
      const articulosUnicos = [...new Set(registros.map(r => r.articulo))];

      artSelect.innerHTML = '<option value="">Seleccionar...</option>';
      articulosUnicos
        .filter(art => art.toLowerCase().includes(filtro))
        .sort()
        .forEach(art => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = art;
          artSelect.appendChild(opt);
        });

      resetColorTalle();
    });

    function resetColorTalle() {
      $('#color').innerHTML = '<option value="">Seleccionar artículo</option>';
      $('#color').disabled = true;
      $('#talle').innerHTML = '<option value="">Seleccionar color</option>';
      $('#talle').disabled = true;
    }

    // ---------- Cambio de artículo ----------
    $('#articulo').addEventListener('change', function () {
      const art = this.value;
      const colores = [...new Set(registros.filter(r => r.articulo === art).map(r => r.color))].sort();
      const colorSelect = $('#color');
      colorSelect.innerHTML = '<option value="">Seleccionar...</option>';
      colores.forEach(c => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = c;
        colorSelect.appendChild(opt);
      });
      colorSelect.disabled = false;

      const talleSelect = $('#talle');
      talleSelect.innerHTML = '<option value="">Seleccionar color</option>';
      talleSelect.disabled = true;
    });

    // ---------- Cambio de color ----------
    $('#color').addEventListener('change', function () {
      const art = $('#articulo').value;
      const color = this.value;
      const talles = [...new Set(registros
        .filter(r => r.articulo === art && r.color === color)
        .map(r => r.talle)
      )].sort((a,b)=> (''+a).localeCompare(b, undefined, {numeric:true}));
      const talleSelect = $('#talle');
      talleSelect.innerHTML = '<option value="">Seleccionar...</option>';
      talles.forEach(t => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = t;
        talleSelect.appendChild(opt);
      });
      talleSelect.disabled = false;
    });

    // ---------- Agregar a la lista de PICKEO ----------
    $('#agregar').addEventListener('click', function () {
      const art = $('#articulo').value;
      const color = $('#color').value;
      const talle = $('#talle').value;

      if (!art || !color || !talle) {
        alert('Completá Artículo, Color y Talle.');
        return;
      }
      const resultado = registros.find(r => r.articulo === art && r.color === color && r.talle === talle);
      if (resultado) {
        lista.push(resultado.codigo); // repetidos = cantidad
        const li = document.createElement('li');
        li.textContent = resultado.codigo;
        $('#lista').appendChild(li);
        actualizarPills();
      } else {
        alert('No se encontró el código para esa combinación.');
      }
    });

    $('#limpiarPickeo').addEventListener('click', () => {
      lista = [];
      $('#lista').innerHTML = '';
      actualizarPills();
    });

    function actualizarPills(){
      const unicos = new Set(lista);
      $('#pillPickeo').textContent = `${lista.length} totales • ${unicos.size} únicos`;
    }

    // ---------- Descargar TXT (PICKEO) ----------
    $('#descargar').addEventListener('click', function () {
      if (lista.length === 0) return alert('No hay códigos agregados.');
      const meta = obtenerMeta();
      if (!meta.ok) return;
      const contenido = lista.join('\n');
      descargarComoTXT(contenido, 'PICKEO', meta);
    });

    // ---------- BAJAS ----------
    const bajasInput = $('#bajasInput');
    const pillBajas  = $('#pillBajas');

    function parsearBajas(raw) {
      // separadores: salto de línea, coma, punto y coma, tab, espacios múltiples
      const tokens = raw.split(/[\n,;\t ]+/).map(t => t.trim()).filter(Boolean);
      // dedupe conservando orden
      const set = new Set(), out = [];
      for (const t of tokens){ if(!set.has(t)){ set.add(t); out.push(t); } }
      return out;
    }

    function actualizarBajasPill() {
      const items = parsearBajas(bajasInput.value);
      pillBajas.textContent = `${items.length} código${items.length!==1?'s':''}`;
    }

    bajasInput.addEventListener('input', actualizarBajasPill);

    $('#limpiarBajas').addEventListener('click', () => {
      bajasInput.value = '';
      actualizarBajasPill();
    });

    $('#copiarBajas').addEventListener('click', async () => {
      const items = parsearBajas(bajasInput.value);
      if (items.length === 0) return alert('No hay códigos en BAJAS.');
      try {
        await navigator.clipboard.writeText(items.join('\n'));
        alert('Bajas copiadas al portapapeles.');
      } catch {
        alert('No se pudo copiar. Permití el acceso al portapapeles.');
      }
    });

    $('#descargarBajas').addEventListener('click', function () {
      const items = parsearBajas(bajasInput.value);
      if (items.length === 0) return alert('No hay códigos en BAJAS.');
      const meta = obtenerMeta();
      if (!meta.ok) return;
      const contenido = items.join('\n');
      descargarComoTXT(contenido, 'BAJAS', meta);
    });

    // ---------- Metadatos y descarga ----------
    function obtenerMeta(){
      const responsable = ($('#responsable').value || '').trim();
      const piso = ($('#piso').value || '').trim();
      const sector = ($('#sector').value || '').trim();

      if (!responsable) { alert('Completá el RESPONSABLE.'); return {ok:false}; }
      if (!piso)        { alert('Seleccioná el PISO.');      return {ok:false}; }
      if (!sector)      { alert('Completá el SECTOR.');      return {ok:false}; }

      // Sanitizar a MAYÚSCULAS y guion bajo
      const norm = (s) => s.normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'') // quitar tildes
        .replace(/[^a-zA-Z0-9]+/g,'_')  // no alfanumérico -> _
        .replace(/^_+|_+$/g,'')         // bordes
        .toUpperCase();

      return {
        ok:true,
        responsable: norm(responsable),
        piso: norm(piso),
        sector: norm(sector)
      };
    }

    function yyyymmdd(){
      const d = new Date();
      const y = String(d.getFullYear());
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd= String(d.getDate()).padStart(2,'0');
      return `${y}${m}${dd}`;
    }

    function descargarComoTXT(contenido, prefijo, meta) {
      const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);

      const fecha = yyyymmdd();
      a.download = `${prefijo}_${fecha}_${meta.piso}_${meta.sector}_${meta.responsable}.txt`;

      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    }
  </script>
</body>
</html>
