<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario RIO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin:0; font-family:Arial, sans-serif;
      background:#f4f4f9; color:#222;
    }
    .container{max-width:900px; margin:20px auto; padding:20px}
    h1{margin-bottom:16px; text-align:center}
    .card{
      background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,.1);
      margin-bottom:20px;
    }
    label{display:block; margin:10px 0 5px; font-weight:bold}
    input[type="text"]{
      width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:15px;
    }
    .row{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px}
    .actions{margin-top:15px; display:flex; gap:10px; flex-wrap:wrap}
    button{
      background:#2563eb; color:#fff; border:none; border-radius:6px;
      padding:10px 16px; cursor:pointer; font-weight:bold;
    }
    button.secondary{background:#111827}
    button.ghost{background:#fff; color:#111; border:1px solid #ccc}
    ul.results{list-style:none; padding:0; margin:15px 0 0; max-height:350px; overflow:auto; border-top:1px solid #eee}
    ul.results li{padding:8px 6px; border-bottom:1px solid #eee; font-size:14px}
    .registrado{color:green}
    .no-registrado{color:red}
    .statusbar{display:flex; gap:15px; flex-wrap:wrap; margin-bottom:10px}
    .chip{padding:4px 10px; border-radius:999px; font-size:13px; border:1px solid #ccc; background:#fafafa}
  </style>
</head>
<body>
  <div class="container">
    <h1>Inventario RIO</h1>

    <!-- Configuración -->
    <form id="config-form" class="card">
      <div class="row">
        <div>
          <label for="piso">Piso</label>
          <input type="text" id="piso" required />
        </div>
        <div>
          <label for="sector">Sector</label>
          <input type="text" id="sector" required />
        </div>
        <div>
          <label for="responsable">Responsable</label>
          <input type="text" id="responsable" required />
        </div>
      </div>
      <div class="actions">
        <button type="submit">Comenzar</button>
      </div>
    </form>

    <!-- Escaneo -->
    <div id="scanner" class="card" style="display:none;">
      <div class="statusbar">
        <div class="chip">Registrados: <strong id="registrados-count">0</strong></div>
        <div class="chip">No registrados: <strong id="no-registrados-count">0</strong></div>
      </div>

      <label for="code-input">Escaneá el código</label>
      <input type="text" id="code-input" autocomplete="off" autofocus />

      <div class="actions">
        <button id="export-registered" type="button">Exportar Registrados</button>
        <button id="export-unregistered" type="button" class="secondary">Exportar No Registrados</button>
        <button id="clear-list" type="button" class="ghost">Limpiar lista</button>
      </div>

      <ul id="results" class="results"></ul>
    </div>
  </div>

  <script>
    let equivalencias = {};
    let registrados = [];
    let noRegistrados = [];
    let piso="", sector="", responsable="";
    let inputBuffer=''; let debounceTimer=null;

    // --- Inicio ---
    document.getElementById('config-form').addEventListener('submit', async e=>{
      e.preventDefault();
      piso=document.getElementById('piso').value.trim();
      sector=document.getElementById('sector').value.trim();
      responsable=document.getElementById('responsable').value.trim();
      await loadCSV();
      document.getElementById('config-form').style.display='none';
      document.getElementById('scanner').style.display='block';
      document.getElementById('code-input').focus();
    });

    // --- Escáner ---
    document.getElementById('code-input').addEventListener('paste',e=>{
      e.preventDefault();
      const pasted=(e.clipboardData||window.clipboardData).getData('text');
      handleScannedText(pasted);
      e.target.value='';
    });
    document.getElementById('code-input').addEventListener('input',e=>{
      inputBuffer=e.target.value;
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(()=>{
        if(inputBuffer) handleScannedText(inputBuffer);
        inputBuffer=''; e.target.value='';
      },120);
    });
    document.getElementById('code-input').addEventListener('keydown',e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        handleScannedText(e.target.value);
        inputBuffer=''; e.target.value='';
      }
    });

    function handleScannedText(text){
      if(!text) return;
      let code=String(text).replace(/^\uFEFF/,'').replace(/\r?\n/g,'').replace(/\s+/g,'').trim();
      code=code.replace(/[^\w\-]/g,'');
      if(code.length<6) return;
      registrarCodigo(code);
      document.getElementById('code-input').focus();
    }

    function registrarCodigo(code){
      const result=equivalencias[code];
      const display=result?`${code} - ${result}`:`${code} - Equivalencia no registrada`;
      const li=document.createElement('li');
      li.textContent=display;
      li.className=result?'registrado':'no-registrado';
      document.getElementById('results').appendChild(li);

      if(result){
        registrados.push({code,result});
        document.getElementById('registrados-count').textContent=registrados.length;
      }else{
        noRegistrados.push(code);
        document.getElementById('no-registrados-count').textContent=noRegistrados.length;
      }
    }

    document.getElementById('export-registered').addEventListener('click',()=>{
      const date=new Date().toISOString().split('T')[0].replace(/-/g,'');
      const name=`stock_${date}_${piso}_${sector}_${responsable}.csv`;
      const content='Codigo;Equivalencia\n'+registrados.map(r=>`${r.code};${r.result}`).join('\n');
      downloadCSV(name,content);
    });
    document.getElementById('export-unregistered').addEventListener('click',()=>{
      const date=new Date().toISOString().split('T')[0].replace(/-/g,'');
      const name=`no_registrados_${date}_${piso}_${sector}_${responsable}.csv`;
      const content='Codigo\n'+noRegistrados.join('\n');
      downloadCSV(name,content);
    });
    document.getElementById('clear-list').addEventListener('click',()=>{
      registrados=[]; noRegistrados=[];
      document.getElementById('registrados-count').textContent='0';
      document.getElementById('no-registrados-count').textContent='0';
      document.getElementById('results').innerHTML='';
      document.getElementById('code-input').focus();
    });

    function downloadCSV(filename,content){
      const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.setAttribute('download',filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function loadCSV(){
      try{
        const response=await fetch('equivalencias.csv');
        const raw=await response.text();
        const text=raw.replace(/\r/g,'').replace(/^\uFEFF/,'');
        let lines=text.split('\n').filter(Boolean);
        if(lines.length===0){alert('CSV vacío o no encontrado');return;}
        const header=lines[0].replace(/"/g,'').split(';').map(h=>h.trim().toLowerCase());
        const idxCodigo=0, idxArticulo=1, idxDesc1=2, idxDesc2=3;
        for(let i=1;i<lines.length;i++){
          const parts=lines[i].replace(/"/g,'').split(';');
          let code=(parts[idxCodigo]||'').trim().replace(/\s+/g,'');
          if(!code) continue;
          const articulo=parts[idxArticulo]||'';
          const desc1=parts[idxDesc1]||'';
          const desc2=parts[idxDesc2]||'';
          const descripcion=[articulo,desc1,desc2].filter(Boolean).join(' - ');
          equivalencias[code]=descripcion;
        }
        console.log("Equivalencias cargadas:",Object.keys(equivalencias).length);
      }catch(err){
        console.error(err); alert('No se pudo leer equivalencias.csv. Abrí este HTML con un servidor local.');
      }
    }
  </script>
</body>
</html>
