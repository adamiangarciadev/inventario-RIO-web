<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pickeo de Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#2a7de1; --ok:#16a34a; --bad:#dc2626; --light:#f6f7fb; --border:#e5e7eb; --text:#0f172a; --sub:#475569; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--light);color:var(--text)}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 14px}
    .topbar{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:#fff}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px}
    .status{display:flex;gap:10px;align-items:center;margin-top:8px;font-weight:600}
    .status .ok{color:var(--ok)}
    .status .bad{color:var(--bad)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2f7;font-size:12px;margin-left:8px}
    .flex{display:flex;gap:10px;align-items:center}
    button{padding:10px 14px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px;background:#f8fafc}
    th{font-size:13px;color:#475569;background:#eef2ff}
    td.count{text-align:center;width:120px}
    .section-title{display:flex;align-items:center;gap:8px;margin:20px 0 8px}
    @media (max-width: 900px){ .topbar{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pickeo de Stock</h1>

    <section class="topbar">
      <div>
        <label for="responsable">Responsable</label>
        <input id="responsable" type="text" placeholder="Ej: Damian Garcia" />
      </div>
      <div>
        <label for="piso">Piso</label>
        <select id="piso">
          <option value="">Seleccionar...</option>
          <option value="LOCAL">LOCAL</option>
          <option value="DEPOSITO">DEPOSITO</option>
          <option value="WEB">WEB</option>
          <option value="PEDIDOS">PEDIDOS</option>
        </select>
      </div>
      <div>
        <label for="sector">Sector</label>
        <input id="sector" type="text" placeholder="Ej: Ingreso / Salida / Lencería" />
      </div>
    </section>

    <section class="card">
      <div class="flex" style="justify-content:space-between;flex-wrap:wrap;gap:12px">
        <div class="flex" style="gap:12px;flex:1 1 320px">
          <div style="flex:1">
            <label for="scan">Escanear / pegar códigos</label>
            <input id="scan" type="text" placeholder="Enfocá aquí y escaneá (Enter para confirmar)" autocomplete="off" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="confirmar">Confirmar</button>
          </div>
        </div>
        <div class="status" id="estado"><span class="bad">Cargando base…</span></div>
      </div>

      <div class="flex" style="margin-top:8px;flex-wrap:wrap">
        <div class="pill" id="pillTotal">0 válidos totales</div>
        <div class="pill" id="pillUnicos">0 válidos únicos</div>
        <div class="pill" id="pillInvalidos">0 inválidos</div>
      </div>

      <div class="flex" style="margin:12px 0;flex-wrap:wrap;gap:8px">
        <button id="descargarValidos">Descargar TXT válidos</button>
        <button id="descargarInvalidos">Descargar TXT inválidos</button>
      </div>

      <div style="overflow:auto;margin-top:6px">
        <table>
          <thead>
            <tr>
              <th style="width:72px">#</th>
              <th>Código</th>
              <th>Artículo</th>
              <th>Color</th>
              <th>Talle</th>
              <th class="count">Cantidad</th>
            </tr>
          </thead>
          <tbody id="tablaValidos"></tbody>
        </table>
      </div>

      <div class="section-title">
        <h2 style="margin:0;font-size:18px">Códigos inválidos</h2>
        <span class="pill" id="pillInvalidos2">0 códigos</span>
      </div>

      <div style="overflow:auto;margin-top:6px">
        <table>
          <thead>
            <tr>
              <th style="width:72px">#</th>
              <th>Código</th>
              <th class="count">Cantidad</th>
            </tr>
          </thead>
          <tbody id="tablaInvalidos"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ===== Normalización y utilidades =====
    const normUp = (s) => (s ?? '').toString()
      .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
      .trim().toUpperCase();
    const keyify = (s) => normUp(s).replace(/[^A-Z0-9]/g,'');
    const $ = (s) => document.querySelector(s);

    const COLOR_ALIASES = {
      'S':'SURTIDO','SUR':'SURTIDO',
      'U':'UNICO','UN':'UNICO','UNQ':'UNICO',
      'N':'NEGRO','NE':'NEGRO','BK':'NEGRO',
      'B':'BLANCO','BL':'BLANCO','BLA':'BLANCO','WH':'BLANCO',
      'A':'AZUL','AZ':'AZUL',
      'R':'ROJO','RO':'ROJO',
      'V':'VERDE','VE':'VERDE',
      'GR':'GRIS','GRA':'GRIS',
      'CE':'CELESTE','CR':'CRUDO',
      'NA':'NATURAL','NU':'NUDE',
      'BE':'BEIGE','MA':'MARRON','LI':'LILA',
      'AM':'AMARILLO','BO':'BORDO','FU':'FUCSIA'
    };
    const TALLE_ALIASES = {'U':'UNICO','UN':'UNICO','UNQ':'UNICO'};

    // ===== Estado =====
    let picks = [];                // válidos (codeKey) con repetidos
    let counts = new Map();        // codeKey -> cantidad
    let invalidPicks = [];         // inválidos normalizados con repetidos
    let invalidCounts = new Map(); // inválidos -> cantidad

    // Índices
    const codeInfo = new Map();       // codeKey -> {codigo, articulo, color, talle}
    const comboToCode = new Map();    // artKey|colorKey|talleKey -> codeKey
    const artColors = new Map();      // artKey -> Set(colorKey)
    const artTalles = new Map();      // artKey -> Set(talleKey)

    function yyyymmdd(){ const d=new Date(); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; }
    function sanitizeForFile(s){ return normUp(s).replace(/[^A-Z0-9]+/g,'_').replace(/^_+|_+$/g,''); }
    function setEstado(ok,msg){ $('#estado').innerHTML = ok ? `<span class="ok">✅ ${msg||'Válido'}</span>` : `<span class="bad">❌ ${msg||'No registrado'}</span>`; }
    function updatePills(){
      $('#pillTotal').textContent    = `${picks.length} válidos totales`;
      $('#pillUnicos').textContent   = `${counts.size} válidos únicos`;
      $('#pillInvalidos').textContent  = `${invalidPicks.length} inválidos`;
      $('#pillInvalidos2').textContent = `${invalidCounts.size} códigos`;
    }
    function renderTablaValidos(){
      const tb = $('#tablaValidos'); tb.innerHTML = ''; let i=1;
      for (const [codeKey, qty] of counts.entries()){
        const info = codeInfo.get(codeKey) || {codigo: codeKey, articulo:'-', color:'-', talle:'-'};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="background:#fff">${i++}</td>
                        <td>${info.codigo}</td>
                        <td>${info.articulo}</td>
                        <td>${info.color}</td>
                        <td>${info.talle}</td>
                        <td class="count">${qty}</td>`;
        tb.appendChild(tr);
      }
    }
    function renderTablaInvalidos(){
      const tb = $('#tablaInvalidos'); tb.innerHTML = ''; let i=1;
      for (const [code, qty] of invalidCounts.entries()){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="background:#fff">${i++}</td>
                        <td>${code}</td>
                        <td class="count">${qty}</td>`;
        tb.appendChild(tr);
      }
    }

    // Resolución de alias/prefijos para color y talle
    function resolveColorKey(artKey, rawColor){
      const set = artColors.get(artKey) || new Set();
      const alias = COLOR_ALIASES[normUp(rawColor)];
      const kIn = keyify(rawColor);
      const kAlias = alias ? keyify(alias) : null;
      if (kAlias && set.has(kAlias)) return kAlias;
      if (set.has(kIn)) return kIn;
      const pref = [...set].filter(k => k.startsWith(kIn));
      if (pref.length === 1) return pref[0];
      return kIn;
    }
    function resolveTalleKey(artKey, rawTalle){
      const set = artTalles.get(artKey) || new Set();
      const alias = TALLE_ALIASES[normUp(rawTalle)];
      const kIn = keyify(rawTalle);
      const kAlias = alias ? keyify(alias) : null;
      if (kAlias && set.has(kAlias)) return kAlias;
      if (set.has(kIn)) return kIn;
      const pref = [...set].filter(k => k.startsWith(kIn));
      if (pref.length === 1) return pref[0];
      return kIn;
    }

    // Parse "ART!COLOR!TALLE"
    function parseComposite(s){
      const txt = normUp(s);
      if (!txt.includes('!')) return null;
      const parts = txt.split('!').map(p => p.trim()).filter(Boolean);
      if (parts.length !== 3) return null;
      return { art: parts[0], col: parts[1], tal: parts[2] };
    }

    function addValido(input){
      const raw = input.toString();
      const codeKey = normUp(raw);

      // 1) ¿Código directo?
      const infoDirect = codeInfo.get(codeKey);
      if (infoDirect){
        picks.push(codeKey);
        counts.set(codeKey, (counts.get(codeKey)||0)+1);
        setEstado(true, `${infoDirect.codigo} OK — ${infoDirect.articulo} / ${infoDirect.color} / ${infoDirect.talle}`);
        updatePills(); renderTablaValidos(); return;
      }

      // 2) ¿ART!COLOR!TALLE?
      const comp = parseComposite(raw);
      if (comp){
        const artKey = keyify(comp.art);
        const colorKey = resolveColorKey(artKey, comp.col);
        const talleKey = resolveTalleKey(artKey, comp.tal);
        const mappedCodeKey = comboToCode.get(`${artKey}|${colorKey}|${talleKey}`);
        if (mappedCodeKey){
          const info = codeInfo.get(mappedCodeKey);
          picks.push(mappedCodeKey);
          counts.set(mappedCodeKey, (counts.get(mappedCodeKey)||0)+1);
          setEstado(true, `${info.codigo} OK — ${info.articulo} / ${info.color} / ${info.talle}`);
          updatePills(); renderTablaValidos(); return;
        }
      }

      // 3) No se encontró → inválido
      const invKey = normUp(raw);
      invalidPicks.push(invKey);
      invalidCounts.set(invKey, (invalidCounts.get(invKey)||0)+1);
      setEstado(false, `${raw} no está registrado`);
      updatePills(); renderTablaInvalidos();
    }

    function processRawInput(raw){
      const tokens = raw.split(/[\n,;\t ]+/).map(t=>t.trim()).filter(Boolean);
      for (const t of tokens) addValido(t);
    }

    // ===== Carga de equivalencias (PRINCIPAL + SECUNDARIA) =====
    function ingestRow(codigo, articulo, color, talle){
      const codeKey = normUp(codigo);
      if (!codeKey) return;

      // Si ya existe ese código, no lo pisamos (la primaria tiene prioridad)
      if (!codeInfo.has(codeKey)) {
        codeInfo.set(codeKey, { codigo, articulo, color, talle });
      }

      const artKey = keyify(articulo);
      const colKey = keyify(color);
      const talKey = keyify(talle);

      if (!artColors.has(artKey)) artColors.set(artKey, new Set());
      if (!artTalles.has(artKey)) artTalles.set(artKey, new Set());
      artColors.get(artKey).add(colKey);
      artTalles.get(artKey).add(talKey);

      const comboKey = `${artKey}|${colKey}|${talKey}`;
      // No pisar combos ya cargados por la primaria
      if (!comboToCode.has(comboKey)) comboToCode.set(comboKey, codeKey);
    }

    async function loadPrimary(){
      try{
        const txt = await fetch('equivalencias.csv').then(r=>r.text());
        const lines = txt.split(/\r?\n/).filter(Boolean);
        if (lines.length <= 1) return;
        const header = lines[0].split(';').map(c=>c.replace(/^"|"$|(\r)/g,'').trim().toLowerCase());
        const pos = (name, fb) => { const i = header.indexOf(name); return i>=0? i : fb; };
        const iCodigo=pos('codigo',0), iArt=pos('articulo',1), iCol=pos('color',2), iTal=pos('talle',3);
        for (const line of lines.slice(1)){
          const cols = line.split(';').map(c=>c.replace(/^"|"$|(\r)/g,'').trim());
          ingestRow(cols[iCodigo]??'', cols[iArt]??'', cols[iCol]??'', cols[iTal]??'');
        }
      }catch(e){ /* silencioso: si falla, seguimos con secundaria */ }
    }

    async function loadSecondary(){
      try{
        const txt = await fetch('equivalencias_secundarias.csv').then(r=>{
          if (!r.ok) throw new Error('no-secondary');
          return r.text();
        });
        // SIN encabezado: cada línea = codigo;articulo;color;talle
        const lines = txt.split(/\r?\n/).filter(Boolean);
        for (const line of lines){
          const cols = line.split(';').map(c=>c.replace(/^"|"$|(\r)/g,'').trim());
          const [codigo='', articulo='', color='', talle=''] = cols;
          ingestRow(codigo, articulo, color, talle);
        }
      }catch(e){
        // Si no existe el archivo, no es error bloqueante
      }
    }

    (async function boot(){
      await loadPrimary();
      await loadSecondary();
      // listo para usar
      if (codeInfo.size > 0) setEstado(false,'Base cargada. Escaneá para validar.');
      else setEstado(false,'No se pudo cargar ninguna equivalencia.');
    })();

    // ===== UI =====
    const scan = $('#scan');
    scan.addEventListener('keydown', e => { if (e.key==='Enter'){ e.preventDefault(); $('#confirmar').click(); } });
    scan.addEventListener('input', ()=>{
      const val = scan.value;
      if (!val.trim()){ setEstado(false,'Pendiente'); return; }

      // preview directo
      const direct = codeInfo.get(normUp(val));
      if (direct){ setEstado(true, `Posible válido — ${direct.articulo} / ${direct.color} / ${direct.talle}`); return; }

      // preview combinado
      const comp = parseComposite(val);
      if (comp){
        const artKey = keyify(comp.art);
        const colorKey = resolveColorKey(artKey, comp.col);
        const talleKey = resolveTalleKey(artKey, comp.tal);
        const mapped = comboToCode.get(`${artKey}|${colorKey}|${talleKey}`);
        if (mapped){
          const info = codeInfo.get(mapped);
          setEstado(true, `Posible válido — ${info.articulo} / ${info.color} / ${info.talle}`);
          return;
        }
      }
      setEstado(false,'No registrado');
    });
    $('#confirmar').addEventListener('click', ()=>{
      const raw = scan.value;
      if (!raw.trim()) return;
      processRawInput(raw);
      scan.value=''; scan.focus();
    });

    // Descargas
    function requireMeta(){
      const responsable=($('#responsable').value||'').trim();
      const piso=($('#piso').value||'').trim();
      const sector=($('#sector').value||'').trim();
      if(!responsable) return alert('Completá el RESPONSABLE.'), null;
      if(!piso)        return alert('Seleccioná el PISO.'), null;
      if(!sector)      return alert('Completá el SECTOR.'), null;
      return { responsable:sanitizeForFile(responsable), piso:sanitizeForFile(piso), sector:sanitizeForFile(sector) };
    }
    function downloadTXT(lines, filename){
      const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    }
    $('#descargarValidos').addEventListener('click', ()=>{
      if (picks.length===0) return alert('No hay códigos válidos pickeados.');
      const m=requireMeta(); if(!m) return;
      downloadTXT(picks, `PICKEO_${yyyymmdd()}_${m.piso}_${m.sector}_${m.responsable}.txt`);
    });
    $('#descargarInvalidos').addEventListener('click', ()=>{
      if (invalidPicks.length===0) return alert('No hay códigos inválidos.');
      const m=requireMeta(); if(!m) return;
      downloadTXT(invalidPicks, `INVALIDOS_${yyyymmdd()}_${m.piso}_${m.sector}_${m.responsable}.txt`);
    });
  </script>
</body>
</html>
